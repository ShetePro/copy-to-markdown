name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
      - uses: actions/checkout@v4

      # 1. å®‰è£… pnpm
      # å®ƒä¼šè‡ªåŠ¨è¯»å–ä½  package.json é‡Œçš„ "packageManager": "pnpm@x.x.x" é…ç½®
      - name: Install pnpm
        uses: pnpm/action-setup@v4

      # 2. è®¾ç½® Node ç¯å¢ƒ + å¼€å¯ pnpm ç¼“å­˜
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'  # ğŸ‘ˆ [ä¿®æ”¹ç‚¹1] è¿™é‡Œå¿…é¡»æ˜¯ 'pnpm'ï¼Œä¸èƒ½æ˜¯ 'npm'

      # 3. å®‰è£…ä¾èµ–
      # pnpm install åœ¨ CI ç¯å¢ƒä¸‹ä¼šè‡ªåŠ¨å¯ç”¨ --frozen-lockfile (ç±»ä¼¼ npm ci)
      - name: Install dependencies
        run: pnpm install --frozen-lockfile  # ğŸ‘ˆ [ä¿®æ”¹ç‚¹2] æ›¿ä»£ npm ci

      # 4. æ„å»ºä¸æµ‹è¯•
      - name: Build
        run: pnpm run build --if-present  # ğŸ‘ˆ [ä¿®æ”¹ç‚¹3] æ”¹ç”¨ pnpm è¿è¡Œ

      - name: Test
        run: pnpm test  # ğŸ‘ˆ [ä¿®æ”¹ç‚¹4] æ”¹ç”¨ pnpm è¿è¡Œ
